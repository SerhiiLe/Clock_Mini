Внимание! Проект пока не готов! Хотя у меня время вполне нормально показывает.

# Очередные часы с будильником, датчиком температуры и давления, на маленькой матрице одноцветных светодиодов.

Основано на моём [прошлом проекте](https://github.com/SerhiiLe/clock-esp8266-ws2812b), но при создании закладывалась совершенно 
другие цели и другой способ использования. Это небольшие настольные часы-будильник, без резервного питания и если утром
электричества не будет, то будильник не разбудит. Естественно, что все "охранные" функции не работают, управление через Telegram
стало не нужно. С другой стороны, плата часов с резервным питанием позволяет отображать время сразу после подачи питания и работать
без интернет. Так-же добавлены простые функции "погодной станции", хотя точность показателей намного хуже полноценной погодной станции.

## Смысл создания этих часов

Существует бесчисленное множество готовых схем и прошивок для намного более функциональных и интересных часов, достаточно
сделать [такой поиск](https://www.google.com/search?q=MAX7219+clock). Например [такие](https://www.thingiverse.com/thing:3924947),
которые умеют наверное всё :) Фактически готовое устройство, прошивку для которого не надо компилировать,
а обновления прилетают из Интернет. И по сути там вся сложность это сделать корпус. Ещё есть такой [замечательный вариант](https://github.com/IZ76/VZ_Clock/tree/master)
А вообще по поиску можно найти много вариантов, от таких сложных и функциональных, как я привёл, до очень простых, но вполне рабочих.

Для меня это часы "антистресс". С одной стороны это очередная никому не нужная версия часиков, с другой стороны это действительно практичная вещь,
а создание как "железа", так и прошивки позволило мне отвлечься от рутины будней. И не дать заплесневеть мозгам. А ещё интересно сравнить,
как решил ту или иную проблему я и как её решали другие. Ход мысли у всех очень разный. Не всегда мой вариант лучше.

## Ход создания часов

В начале я хотел сделать маленький вариант часов из моего [прошлого проекта](https://github.com/SerhiiLe/clock-esp8266-ws2812b),
просто выкинув всё лишнее. Всего за день адаптации у меня уже матрица показывала время. Но тогда-же пришло понимание, что так просто не получится.

1. Шрифты которые хорошо работали на большой матрице из адресных светодиодов плохо смотрелись на маленькой матрице с высокой плотностью.
Прошлось частично перерисовать шрифты и добавить ещё один "крошечный" шрифт, который абсолютно не читаемый на большой матрице, но вполне сносно
выглядит на маленькой. Я не использовал обычную для таких часиков библиотеку MAX72xx, с её шрифтами. Только хардкор.

2. Старая, простая схема запуска часов плохо работала и пришлось сделать "отложенный старт", запуск стал стабильным и информативным. Наработки перенесены
в старый проект.

3. В старом проекте очень много внимания было уделено цвету, это логично для цветной матрицы. На монохромной матрице это всё не нужно и пошло под нож.
Зато появилась возможность выводить инвертировать буквы и писать "черным по белому". Выглядит так себе, зато позволяет сделать меню настройки времени кнопками.

4. Самые большие мучения в старом проекте были связаны с модулем DFPlayer, который умеет играть mp3 с SD карточки. Скорее всего мне попался китайски плагиат
китайского чипа, так как если верить интернету, то ни у кого таких как у меня проблем не возникло. С другой стороны, я нашел информацию, что есть как минимум две 
модификации этого чипа с немного разными командами, но у меня не работали оба варианта. Я нашел способ заставить плату работать обеспечивая музыкальный будильник и
это должно работать на любых модификациях платы, но осадок остался. По этому для новых часиков я поставил простую пищалку. У чипа ESP8266 нет аппаратного PWM,
только программная имитация через таймер и прерывания. Из-за этого получить чистый тон проблемно, варианты как на Atmega328p (Arduino) не работают. По этому
пищалка активная, которая умеет выдавать писк только на одной частоте. "Мелодии" это разные варианты продолжительности писка и пауз.

5. Когда я делал прошлый проект, то просто хотел повторить чужой готовый и ничего не знал ни про варианты плат ни про схемотехнику. Если было написано, что платы
NodeMCU это хорошо, а WeMos D1 mini это плохо и есть проблемы с устойчивостью работы, то я в это верил. Практика показала, что зря. WeMos D1 mini отличная плата,
она компактная и на ней выведены только те ноги, которые можно использовать, а по устойчивости она ни чем не отличается. Да и при программировании, разница только в
таблице соответствия обозначений на плате и в программе. Но если к примеру вместо D0 писать 16, можно выбирать любую плату с чипом esp8266.

6. У esp8266 очень мало свободных входов/выходов, всего 9 цифровых и 1 аналоговый. Ещё два это TX/RX используется для программирования и вывода сообщений отладки.
Из этих 9 два I2C и четыре SPI. Остаётся 3, один работает через таймер, а два используются для входа в режим программирования и диагностики запуска, все три нельзя
использовать в момент загрузки. По этому, для возможности подключить пищалку и чтобы она не пищала при каждом старте, матрица подключается программным SPI, что не
добавляет стабильности, но и не вызывает заметных проблем.

7. ESP8266 или ESP32? Теперь я понимаю, что для прошлого проекта нужна была плата ESP32, больше пинов, в том числе аналоговых позволило бы не просто смотреть наличие
+5В, а и измерять напряжение аккумулятора. Два ядра позволило бы вынести работу с WiFi и кнопками на отдельное ядро, что устранило-бы или сильно уменьшило
ефект "залипания" или "замерзание" картинки. Второй аппаратный Serial добавил бы стабильность работы с DFPlayer. Поддержка чипом сенсорных входов позволило-бы отказаться
от отдельной кнопки и добавить их хотя-бы две, что позволило бы выставлять время с кнопок, а не только через WiFi. Но тогда я этого не знал, а сейчас часы заклеены
намертво и разваливать корпус совсем не хочется. С другой стороны для маленьких часиков всё это не нужно, по этому ESP8266 подходит больше из-за компактности.
Чипы ESP8266 и ESP32 очень разные не только количеством ядер ножками и памятью, самое главное отличие в том, что ESP8266 имеет свою "OS" - ESP-IDF
(Espressif IoT Development Framework), а ESP32 работает на FreeRTOS. Даже если писать на Arduino, то всё равно это различие не позволяет писать 100% переносимый код.

8. В старом проекте конфигурация сохранялась в виде JSON файлов на внутренней LittleFS и выдавалась оттуда напрямую в WEB интерфейс. Основной риск в том, что число
циклов записи на флеш по паспорту всего 10тыс. На плате часов HW-111 (DS1307) установлен EEPROM объёмом 4096 байт и ресурсом циклов записи 1 миллион. Просто грех
не использовать его. Я разработал простейший вариант хранения настроек в виде областей с контрольной суммой. Минус в том, что любое изменение структуры делает
старый конфиг не читаемым и происходит новая инициализация. С другой стороны такое хранение намного проще, чем JSON и нет проблем с сохранением настроек, с которым
я столкнулся пытаясь повторить проект больших часиков и это было одной из причин начать делать свой.

9. При написании старого проекта у меня был вопрос, как сделать из статичной странички динамическую и приемлемо выглядящую как на большом мониторе, так и на телефоне.
Динамика создаётся javascript и JSON. А оформление я сделал на основе таблиц. Как показала практика, таблицы это относительно быстро и просто, но есть ограничения.
По этому я переосмыслил интерфейс и переписал таблицы в flex. Практически то-же, но отображение стало более гибким. Был вариант использовать готовый конструктор вроде
[GyverPortal](https://github.com/GyverLibs/GyverHub) или [JeeUI](https://github.com/jeecrypt) или [WebApp Builder](https://wicard.net/projects/Arduino/ESP32-ESP8266/esp8266-webapp-builder), возможно было бы лучше, но как-же тогда свой велосипед?

10. Плата часов HW-111 как и многие другие предназначены под установку аккумулятора, а не батареи, там есть цепь заряда, а это убивает обычные батарейки.
Впрочем как говорит интернет и аккумуляторы тоже долго не живут. Для решения проблемы надо переставить диод на плате, как сделал я. Но лучше выпаять вообще отсек
батареи и припаять ионистор (суперконденсатор). Ионистор вечный, по сравнению с батарейками или аккумуляторами и заряд будет держать минимум месяц.

11. Вывод крошечным шрифтом - полная лажа. Как и всякие эффекты. Часы 90% времени должны просто и максимально скучно показывать время. Это их главное предназначение.
И вообще, часто что-то делаешь, ломаешь голову, а потом оказывается, что это не нужно. И дилема, удалить или оставить.

