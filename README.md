Внимание! Проект пока не готов! Хотя у меня время вполне нормально показывает.

# Очередные часы с будильником, датчиком температуры и давления, на маленькой матрице одноцветных светодиодов.

Основано на моём [прошлом проекте](https://github.com/SerhiiLe/clock-esp8266-ws2812b), но при создании закладывалась совершенно другие цели и другой способ использования. Это небольшие настольные часы-будильник, без резервного питания и если утром электричества не будет, то будильник не разбудит. Естественно, что все "охранные" функции не работают, управление через Telegram стало не нужно. С другой стороны, плата часов с резервным питанием позволяет отображать время сразу после подачи питания и работать без интернет. Так-же добавлены простые функции "погодной станции", хотя точность показателей намного хуже полноценной погодной станции.

## Смысл создания этих часов

Существует бесчисленное множество готовых схем и прошивок для намного более функциональных и интересных часов, достаточно сделать [такой поиск](https://www.google.com/search?q=MAX7219+clock). Например [такие](https://www.thingiverse.com/thing:3924947), которые умеют наверное всё :) Фактически готовое устройство, прошивку для которого не надо компилировать, а обновления прилетают из Интернет. И по сути там вся сложность это сделать корпус. Ещё есть такой [замечательный вариант](https://github.com/IZ76/VZ_Clock) А вообще по поиску можно найти много вариантов, от таких сложных и функциональных, как я привёл, до очень простых, но вполне рабочих.

Для меня это часы "антистресс". С одной стороны это очередная никому не нужная версия часиков, с другой стороны это действительно практичная вещь, а создание как "железа", так и прошивки позволило мне отвлечься от рутины будней. И не дать заплесневеть мозгам. А ещё интересно сравнить, как решил ту или иную проблему я и как её решали другие. Ход мысли у всех очень разный. Не всегда мой вариант лучше.

## Ход создания часов

В начале я хотел сделать маленький вариант часов из моего [прошлого проекта](https://github.com/SerhiiLe/clock-esp8266-ws2812b), просто выкинув всё лишнее. Всего за день адаптации у меня уже матрица показывала время. Но тогда-же пришло понимание, что так просто не получится.

1. Шрифты которые хорошо работали на большой матрице из адресных светодиодов плохо смотрелись на маленькой матрице с высокой плотностью. Прошлось частично перерисовать шрифты и добавить ещё один "крошечный" шрифт, который абсолютно не читаемый на большой матрице, но вполне сносно выглядит на маленькой. Свои шрифты это дело вкуса. Я не использовал обычную для таких часиков библиотеку MAX72xx, с её шрифтами. Только хардкор.

2. Старая, простая схема запуска часов плохо работала и пришлось сделать "отложенный старт", запуск стал стабильным и информативным. Наработки перенесены в старый проект.

3. В старом проекте очень много внимания было уделено цвету, это логично для цветной матрицы. На монохромной матрице это всё не нужно и пошло под нож. Зато появилась возможность выводить инвертировать буквы и писать "черным по белому". Выглядит так себе, зато позволяет сделать меню настройки времени кнопками.

4. Самые большие мучения в старом проекте были связаны с модулем DFPlayer, который умеет играть mp3 с SD карточки. Скорее всего мне попался китайски плагиат китайского чипа, так как если верить интернету, то ни у кого таких как у меня проблем не возникло. С другой стороны, я нашел информацию, что есть как минимум две модификации этого чипа с немного разными командами, но у меня не работали оба варианта. Я нашел способ заставить плату работать обеспечивая музыкальный будильник и это должно работать на любых модификациях платы, но осадок остался. По этому для новых часиков я поставил простую пищалку. У чипа ESP8266 нет аппаратного PWM, только программная имитация через таймер и прерывания. Из-за этого получить чистый тон проблемно, варианты как на Atmega328p (Arduino) не работают. По этому пищалка активная, которая умеет выдавать писк только на одной частоте. "Мелодии" это разные варианты продолжительности писка и пауз.

5. Когда я делал прошлый проект, то просто хотел повторить чужой готовый и ничего не знал ни про варианты плат ни про схемотехнику. Если было написано, что платы NodeMCU это хорошо, а WeMos D1 mini это плохо и есть проблемы с устойчивостью работы, то я в это верил. Практика показала, что зря. WeMos D1 mini отличная плата, она компактная и на ней выведены только те ноги, которые можно использовать, а по устойчивости она ни чем не отличается. Да и при программировании, разница только в таблице соответствия обозначений на плате и в программе. Но если к примеру вместо D0 писать 16, можно выбирать любую плату с чипом esp8266.

6. У esp8266 очень мало свободных входов/выходов, всего 9 цифровых и 1 аналоговый. Ещё два это TX/RX используется для программирования и вывода сообщений отладки. Из этих 9 два I2C и четыре SPI. Остаётся 3, один работает через таймер, а два используются для входа в режим программирования и диагностики запуска, все три нельзя использовать в момент загрузки. По этому, для возможности подключить пищалку и чтобы она не пищала при каждом старте, матрица подключается программным SPI, что не добавляет стабильности, но и не вызывает заметных проблем.

7. ESP8266 или ESP32? Теперь я понимаю, что для прошлого проекта нужна была плата ESP32, больше пинов, в том числе аналоговых позволило бы не просто смотреть наличие +5В, а и измерять напряжение аккумулятора. Два ядра позволило бы вынести работу с WiFi и кнопками на отдельное ядро, что устранило-бы или сильно уменьшило ефект "залипания" или "замерзание" картинки. Второй аппаратный Serial добавил бы стабильность работы с DFPlayer. Поддержка чипом сенсорных входов позволило-бы отказаться от отдельной кнопки и добавить их хотя-бы две, что позволило бы выставлять время с кнопок, а не только через WiFi. Но тогда я этого не знал, а сейчас часы заклеены намертво и разваливать корпус совсем не хочется. С другой стороны для маленьких часиков всё это не нужно, по этому ESP8266 подходит больше из-за компактности. Чипы ESP8266 и ESP32 очень разные не только количеством ядер ножками и памятью, самое главное отличие в том, что ESP8266 имеет свою "OS" - ESP-IDF (Espressif IoT Development Framework), а ESP32 работает на FreeRTOS. Даже если писать на Arduino, то всё равно это различие не позволяет писать 100% переносимый код.

8. В старом проекте конфигурация сохранялась в виде JSON файлов на внутренней LittleFS и выдавалась оттуда напрямую в WEB интерфейс. Основной риск в том, что число циклов записи на флеш по паспорту всего 10тыс. На плате часов HW-111 (DS1307) установлен EEPROM объёмом 4096 байт и ресурсом циклов записи 1 миллион. Просто грех не использовать его. Я разработал простейший вариант хранения настроек в виде областей с контрольной суммой. Минус в том, что любое изменение структуры делает старый конфиг не читаемым и происходит новая инициализация. С другой стороны такое хранение намного проще, чем JSON и нет проблем с сохранением настроек, с которым я столкнулся пытаясь повторить проект больших часиков и это было одной из причин начать делать свой.

9. При написании старого проекта у меня был вопрос, как сделать из статичной странички динамическую и приемлемо выглядящую как на большом мониторе, так и на телефоне. Динамика создаётся javascript и JSON. А оформление я сделал на основе таблиц. Как показала практика, таблицы это относительно быстро и просто, но есть ограничения. По этому я переосмыслил интерфейс и переписал таблицы в flex. Практически то-же, но отображение стало более гибким. Был вариант использовать готовый конструктор вроде [GyverPortal](https://github.com/GyverLibs/GyverHub), или [JeeUI](https://github.com/jeecrypt), или [WebApp Builder](https://wicard.net/projects/Arduino/ESP32-ESP8266/esp8266-webapp-builder), или [EmbUI](https://github.com/vortigont/EmbUI) возможно было бы лучше, но как-же тогда свой велосипед?

10. Плата часов HW-111 как и многие другие предназначены под установку аккумулятора, а не батареи, там есть цепь заряда, а это убивает обычные батарейки. Впрочем как говорит интернет и аккумуляторы тоже долго не живут. Для решения проблемы надо переставить диод на плате, как сделал я. Но лучше выпаять вообще отсек батареи и припаять ионистор (суперконденсатор). Ионистор вечный, по сравнению с батарейками или аккумуляторами и заряд будет держать минимум месяц.

11. Вывод крошечным шрифтом - полная лажа. Как и всякие эффекты. Часы 90% времени должны просто и максимально скучно показывать время. Это их главное предназначение. И вообще, часто что-то делаешь, ломаешь голову, а потом оказывается, что это не нужно. И дилема, удалить или оставить.

12. В плане веб-дизайна, каждый броузер имеет свои листы стилей по умолчанию и они километровые. Чтобы страничка смотрелась примерно одинаково во всех броузерах надо писать свои такие-же километровые листы стилей. Или подключать какой-нибудь готовый, как bootstrap. Средняя современная страничка это условный bootstrap + jquery + react + перегруженная вёрстка для обеспечения работы всего этого счастья и вот имеем страничку чуть сложнее чем hello world объёмом 5Мбайт. И такие объёмы требуют скоростных каналов, "примитивный" 3G уже не подходит. 4G тормозит. 5G пока тянет, но срочно нужен 6G... А потом эта страничка развернётся броузером и после компиляции и рендеринга займёт 200Мб памяти. Вот так и живём.

13. При работе с EEPROM обнаружилась неприятная особенность, а именно скорость работы. Запись происходит блоками до 32 байт, после чего нужно чипу давать время на само запоминание, это примерно 20мсек. Полный объём EEPROM 4 кБайт, или 4096/32x0.02=2.56 сек. Если дробить запись на условные int16 то это 4096/2x0.02=40.96 сек. В итоге - писать по пару байт совсем не выгодно, со стороны пользователя это выглядит как зависание железки. Только блочная запись небольшими блоками.

14. Решил поставить готовые прошивки и посмотреть, как реально работают другие велосипеды. 
Два которые я привёл в самом начале самые сложные и функциональные из всего, что я нашел. Почти все прошивки уровня новичка, как-то показывает время и температуру и счастье. Эти две технологически намного сложнее и меня реально удивили некоторые решения. Особенно когда я увидел, что прошивка на IDF вместо Arduino/IDF позволяет избавится от мусора на ножках и полноценно использовать 12 GPIO (к одному надо подпаиваться напрямую к модулю ESP12). Ещё меня удивил подход подключения DFPlayer без обратной связи, кинул команду, а выполнится или нет никого не волнует. Обе прошивки сделаны как универсальные, все драйвера уже внутри и не надо ничего заранее конфигурировать, достаточно через web включить или выключить нужный датчик или периферию.
[Первое место](https://www.thingiverse.com/thing:3924947) за большую стабильность, удобный web и возможность подключить DFPlayer. Профессиональный продукт.
[Второе место](https://github.com/IZ76/VZ_Clock) за нестабильную работу, неадаптированный под смартфон web и изнасилование flash микроконтроллера, есть риск долго не прожить. Зато там есть большой плюс в открытых исходниках и намного лучшей проработки циферблатов.
А я буду продолжать своё. Похоже пик создания часиков всех видов захлестнул планету примерно в 2017 году и практически сошел на нет в 2021.
[Просто бімба :)](https://github.com/bogd/esp32-morphing-clock)

15. Внезапно оказалось, что BearSSL, с помощью которого работает https не поддерживает все варианты шифрования. Процессор esp8266 слишком слабый. Оставлены только самые простые методы. Не все сайты хотят работать со слабым шифрованием. Некоторые сервисы, которые были в планах, отпали. Кроме того запрос http происходит в разы быстрее, чем https.

16. Хотя в планы это не входило, но после знакомства с другими проектами сделал несколько циферблатов. Без эффектов, без миллиона шрифтов, только то, чем бы сам хотел пользоваться. Количество костылей на квадратный метр кода зашкаливает.
